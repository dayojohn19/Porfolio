{% extends "race/layout.html" %}

{% block body %}
<style>
    .eee {
        background-color: rgba(0, 110, 255, 0.123);
        border: solid 1.2px rgba(0, 128, 0, 0.233);
    }
    * {
        border-radius: 10px;
    }
    * input {
        border: none;
        padding: 0.5rem;
        font-size: large;
        margin-bottom: 0.5rem;
    }
    form input {
        border: none;
        background-color: rgba(239, 255, 96, 0.966);
    }
    #valued {
        color: rgb(0, 195, 255);
        font-weight: 700;
    }
    .rlap{
        text-align: center;
        font-size: x-large;
        color: yellow;
    }
    .load_button {
        background-color: yellowgreen;
        font-size: x-large;
        border:none;
    }
    * button {
        border-radius: none;
    }
</style>
<div style="background: #fd747831; border: 2px solid #e664646c; margin: 15px; line-height: 1.5; text-align: center;border-radius:5.5px">
    <h1 id="race_name">
        {{rn.racename}}
    </h1>
    <a style="text-decoration:none; color:lightblue;" href="{% url 'g_pigeon_race:view_race_record' id=rn.id %}">View record</a>
</div>  

<input hidden  id="race_id" value="{{rn.id}}">

<p style="font-size: smaller;">Get the code and Load the Pigeon on the Truck</p>
<div id="e1"></div>
<hr>
    <div style="border: 4px solid red; width:fit-content;" hidden> 
        <div id="lap_id"></div>
        <div id="race_id2">{{rn.id}}</div>
    </div>
    
<h4>Lap:</h4>
<div style="text-align:center;">
    <div style="text-align: left;color: yellow;padding: 1% ;">
        <div>
            <h3 style="margin-bottom: 0; padding-bottom: 0;">Next Lap: </h3>
            <h1 style="margin-top: 0; padding-top: 0;">
                <div id="lap_name">
                </div>
            </h1>
        </div>
    </div>
    {% for l in lap  %}
        <div style="padding-top: 0px;background-color: rgba(255, 140, 0, 0.11);border:3px solid rgba(255, 255, 33, 0.192);margin: 5px; padding: 5%;">

            <p id="lapid" hidden>{{l.id}}</p>
            <h1 style="margin-top: 0;"><p id="valued" >{{l.release}}</p>{{l.num_loaded}} Birds</h1>
            <form action="{% url 'g_pigeon_race:view_loaded' l.id %}">
                <input type="submit" value="View Loaded Pigeons">
            </form>
            <button  id="{{l.id}}" onclick="truck(id)" >Truck</button>
        </div>
        {% empty %}
        <h1>No more lap</h1>
        <a style="text-decoration: none; color: lightblue;" href="{% url 'g_pigeon_race:view_race_record' id=rn.id %}">View Result</a>
    {% endfor %}
</div>
<hr>
<h4 style="color: yellow;">Released Lap:</h4>
{% for r in rlap %}
    <div class="rlap">{{r.release}}
        <div>{{r.char_time}}</div>
        <form action="{% url 'g_pigeon_race:view_clocked' lid=r.id %}">
            <input type="submit" value="View Clocked Pigeons">
        </form>
        <form action="{% url 'g_pigeon_race:view_loaded_dead' rn.id %}">
            <input type="submit" value="View Loaded Pigeons">
        </form>
    </div>
    <hr>
{% endfor %}

<script>


    // getting active lap

lap_id = document.querySelector("#lapid").innerHTML;
lap_name = document.querySelector("#valued").innerHTML;
document.querySelector("#lap_id").innerHTML = lap_id;
document.querySelector("#lap_name").innerHTML = lap_name;
// end of getting active lap
function putpigeon(id) {
        //try put the pigeon to pigeon lap
        fetch(`/race/test/${id}`);
}
function truck(x) {
    yy = `On Truck ${x} `
    alert(x);
}


function loadit(id, state, lapid, lap_num) {
    //putting the pigeon to Loaded MODEL
    code = document.querySelector(`#code-${id}`).value;   
    race_id = document.querySelector("#race_id2").innerHTML;
    race_name = document.querySelector("#race_name").innerHTML;
    fetch(`/g_pigeon_race/loadpigeon/${id}`, {
        method: "PUT",
        body: JSON.stringify({
            lapid:lapid,
            race_name:race_name,
            pid:id,
            lap_num:lap_num,
            race_id:race_id,
            loaded_code: code, 
            loaded: !state
        })
    })
    .then((response) => {
                if (!response.ok) {
                    // error processing
                    throw 'Error';
                }
                return response.json()
            });
   location.reload();
   alert('successfully LOADED');
   //alert(id + " Successfully loaded" + state + "lap:ID" + lapid + "code" + code);
}

    document.addEventListener('DOMContentLoaded', function() {
    rd = document.querySelector("#race_id").value;

    fetch(`lap_pigeon/${rd}`)
.then(response => response.json())
.then(pigeons => {
    pigeons.forEach(element => {
        const e = element;
        const ee = document.createElement('div');
        eee = `<div class="eee"; id="eee-${e.id}"
        style=" padding:3px; margin:3px; border-radius:25px; padding:10px; margin: 15px; line-height: 1.5; text-align: center; width:device-width">
            <p class="pnp">
                "${e.name}" <br>
            Ring: <a style="background-color:rgba(0, 128, 0, 0.233);padding-left:10px;padding-right:10px">${e.ring}</a> <br>
            </p>
            <input id="code-${e.id}"  placeholder="Load Code"  >
            <button class="load_button" id="x-${e.id}">load</button>
            <br>
            Last Load: ${e.loads} <br>
            
            {{lap.id}}
            </div>`;
        ee.innerHTML = eee;
        document.querySelector("#e1").append(ee);


            //put on clock load 
// !! cant find load 
            let lapid = document.querySelector("#valued").innerHTML;
            let lap_num = document.querySelector("#lapid").innerHTML;
            let loaded_code = document.querySelector(`#code-${e.id}`).value;
            let x = document.querySelector(`#x-${e.id}`)
        x.addEventListener("click", event => {
            loadit(e.id, e.loaded, lapid, lap_num);
        });
    //    button.addEventListener("click", event => {
    //        testb(loaded_code)
    //    });
    });

});

    });


</script>
<div style="height: 1000px;"></div>
{%endblock%}